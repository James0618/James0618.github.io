---
layout: post
title: '内参标定理论介绍'
date: 2019-08-09
author: James
color: rgb(255,210,32)
cover: '../2019/08/09/time.png'
tags: ROS手眼标定
---

# 内参标定理论介绍

​		&#8195;&#8195;在任何使用到相机的任务中，相机的内参标定都是一定要进行的，不过大多数购买到的相机都已经进行了提前的标定，不过为了能够更全面的掌握机械臂的手眼标定，我们还是需要掌握相机内参标定的方法。在这节课程中我们将会详细介绍张正友的经典论文`A Flexible New Technique fro Camera Calibration`中提出的基于棋盘格的相机标定方法，在之后的课程中也会从实操角度介绍在ROS中如何对相机的内参进行标定。



## 研究重心

​		&#8195;&#8195;在学习一个新知识点之前首先需要明确这个问题的重心在哪里，使用的方法又是什么，这样才能够发现问题并有希望作出改进。在获取相机内参数的问题中，我们的核心在于使用已知的变量合理的表示内参数，并使用优化方法最终进行求解。在此之前我们先了解一下何为内参数：

​		&#8195;&#8195;在使用针孔相机获取三维世界的图像信息时需要经历这样几个过程：

+ 首先将三维世界中的一点$P=(X,Y,Z)$从世界坐标系通过刚体变换变换到相机所在的坐标系，需要的参数为旋转矩阵$R$和平移向量$t$，称为外参数；
+ 获得了点$P$在相机坐标系下的坐标后，通过针孔相机的模型变换为成像平面上的点$p=(x,y)$；
+ 将点$p$从成像平面通过缩放和平移变换变换到像素坐标系上的点$p=(u,\nu)$。

​       &#8195;&#8195;若将其转换为矩阵相乘的形式可以写成下面的式子：


$$
s
 \left(
 \begin{matrix}
   u \\
   \nu \\
   1 
  \end{matrix}
  \right)
 =
 \left[
 \begin{matrix}
   \alpha & 0 & c_x \\
   0 & \beta & c_y \\
   0 & 0 & 1
  \end{matrix}
  \right]
   \left[
 \begin{matrix}
   f & 0 & 0 & 0 \\
   0 & f & 0 & 0 \\
   0 & 0 & 1 & 0
  \end{matrix}
  \right]
   \left[
 \begin{matrix}
   R & t \\
   0^T & 1 
  \end{matrix}
  \right]
   \left(
 \begin{matrix}
   X \\
   Y \\
   Z \\
   1
  \end{matrix}
  \right)
  \\
  =
   \left[
 \begin{matrix}
   f_x & 0 & c_x & 0 \\
   0 & f_y & c_y & 0 \\
   0 & 0 & 1 & 0
  \end{matrix}
  \right]
     \left[
 \begin{matrix}
   R & t \\
   0^T & 1 
  \end{matrix}
  \right]
     \left(
 \begin{matrix}
   X \\
   Y \\
   Z \\
   1
  \end{matrix}
  \right)
$$

​		&#8195;&#8195;内参数被记做$A$，它表示将坐标系从成像平面变换到像素坐标系的变换矩阵：


$$
A=
 \left[
 \begin{matrix}
   f_x & 0 & c_x \\
   0 & f_y & c_y \\
   0 & 0 & 1
  \end{matrix}
  \right]
$$


​		&#8195;&#8195;而之前所说的外参数$R$和$t$则有上式中的这个矩阵进行表示：


$$
\left[
 \begin{matrix}
   R & t \\
   0^T & 1 
  \end{matrix}
  \right]
$$


​		&#8195;&#8195;其中$f_{x}=\alpha f$，$f_{y}=\beta f$。而$\alpha,\beta$分别表示图像上单位距离内$x$方向和$y$方向的像素个数，因此$f_x,f_y$将相机的焦距变换为在$x,y$方向上的像素度量表示。除此以外，为了不失一般性通常还会在内参矩阵$A$上增加一个参数$\gamma$：


$$
A=
 \left[
 \begin{matrix}
   f_x & \gamma & c_x \\
   0 & f_y & c_y \\
   0 & 0 & 1
  \end{matrix}
  \right]
$$


## 射影变换

​		&#8195;&#8195;在张正友标定法中使用棋盘格标定板进行相机标定，标定板平面是三维世界中的一个平面$\Pi$，而标定板映射到的像素坐标系下的像又是另一个平面$\pi$，因此可以使用射影变换实现两个平面之间的映射，而这只需要知道两个平面的对应点坐标即可求得两个平面之间的射影变换矩阵$H$。

​		&#8195;&#8195;在进行相机标定的时候，我们的标定板都是特制的具有确定型号的，而在运行标定程序时也需要将所使用的标定板的参数输入进去，在执行程序时提取标定板上角点的坐标，而对应角点在像素坐标系下图像的坐标可以通过程序来获取，因此便可以得到两个平面之间的映射。其之间的关系和之前描述的一样，改写成下式：
$$
p=A[R|t]P
$$
​		&#8195;&#8195;其中$p$是像素坐标，$P$是棋盘坐标，因此由刚才对射影变换矩阵的叙述可以得到：


$$
H=A[R|t] \\
p=HP
$$

​		&#8195;&#8195;设棋盘格所在平面为世界坐标系中$Z=0$的平面，这样棋盘格的任一角点P的世界坐标系为$(X,Y,0)$，则有：


$$
s
 \left(
 \begin{matrix}
   u \\
   \nu \\
   1 
  \end{matrix}
  \right)
 =
A[R\ \ t]
   \left(
 \begin{matrix}
   X \\
   Y \\
   0 \\
   1
  \end{matrix}
  \right)
  =
  A[r_1\ \ r_2 \ \ r_3 \ \ t]
   \left(
 \begin{matrix}
   X \\
   Y \\
   0 \\
   1
  \end{matrix}
  \right)
  =
  A[r_1 \ \ r_2 \ \ t]
   \left(
 \begin{matrix}
   X \\
   Y \\
   1
  \end{matrix}
  \right)
  \\
  H = \lambda A[r_1 \ \ r_2 \ \ t] = [h_1 \ \ h_2 \ \ h_3]
$$

​		&#8195;&#8195;将射影变换矩阵转化为这个形式之后，便可以使用棋盘平面和成像平面上对应的点计算射影变换矩阵了。



## 结果推导

&#8195;&#8195;由刚才的式子我们可以得到以下的等式：


$$
\left\{
\begin{aligned}
r_1=\lambda A^{-1}h_1 \\
r_2=\lambda A^{-1}h_2 \\
t = \lambda A^{-1}h_3
\end{aligned}
\right.
$$


&#8195;&#8195;而旋转矩阵$R$是正交矩阵，因此具有以下性质。也就是其列向量之间的内积为0，而每个列向量的模均为1：


$$
r_1^T r_2=0 \\
||r_1||=||r_2||=1
$$



​		&#8195;&#8195;至此，我们得到了在内参标定中非常重要的等式，它是对应与一个射影变换矩阵的约束式，它仅仅表示一对相对应的图像所表示的射影变换矩阵，而在实际操作中往往会取多对图像来计算射影变换矩阵：


$$
\begin{cases}
h_1^T(A^{-1})^TA^{-1}h_2 = 0\\
h_1^T(A^{-1})^TA^{-1}h_1 = h_2^T(A^{-1})^TA^{-1}h_2 = 1
\end{cases}
$$


​		&#8195;&#8195;现在让我们把上式中间那部分矩阵$(A^{-1})^TA^{-1}$改写一下，改写成下面这个矩阵，具体的推导太过于复杂不在这里介绍，感兴趣的可以翻看本节课资料中的论文原件进行研读：


$$
B=(A^{-1})^TA^{-1}=
\left[
 \begin{matrix}
   B_{11} & B_{12} & B_{13} \\
   B_{21} & B_{22} & B_{23} \\
   B_{31} & B_{32} & B_{33}
  \end{matrix}
\right]
=
\left[
 \begin{matrix}
   \frac{1}{\alpha ^2} & -\frac{\gamma}{\alpha^2\beta} & \frac{v_0\gamma-u_0\beta}{\alpha^2\beta} \\
   -\frac{\gamma}{\alpha^2\beta} & \frac{\gamma^2}{\alpha^2\beta^2}+\frac{1}{\beta^2} & -\frac{\gamma(v_0\gamma-u_0\beta)}{\alpha^2\beta^2}-\frac{v_0}{\beta^2} \\
   \frac{v_0\gamma-u_0\beta}{\alpha^2\beta} & -\frac{\gamma(v_0\gamma-u_0\beta)}{\alpha^2\beta^2}-\frac{v_0}{\beta^2} & \frac{(v_0\gamma-u_0\beta)^2}{\alpha^2\beta^2}+\frac{v_0}{\beta^2}+1
  \end{matrix}
\right]
$$


​		&#8195;&#8195;可以看到这个矩阵是一个对称矩阵，因此其仅具有6个未知量，可以将其写成更为紧凑的格式：


$$
b=[B_{11},B_{12},B_{22},B_{13},B_{23},B_{33}]
$$


​		&#8195;&#8195;接下来就应该结合刚才的约束方程来推导得到射影变换矩阵的表达形式了，令$h_i$为矩阵$H$的第$i$个行向量即$h_i=[h_{i1}, h_{i2}, h_{i3}]^T$，则结合之前式子有：


$$
h_i(A^{-1})^TA^{-1}h_j = h_iBh_j=v_{ij}^Tb
$$


其中$v_{ij}=[h_{i1}h_{j1},h_{i1}h_{j2}+h_{i2}h_{j1},h_{i2}h_{j2},h_{i3}h_{j1}+h_{i1}h_{j3},h_{i3}h_{j2}+h_{i2}h_{j3},h_{i3}h_{j3}]$

​		&#8195;&#8195;因此可以将约束方程改写为：


$$
\begin{cases}
h_1^T(A^{-1})^TA^{-1}h_2 = 0\\
h_1^T(A^{-1})^TA^{-1}h_1 = h_2^T(A^{-1})^TA^{-1}h_2 = 1
\end{cases}
\Rightarrow
\begin{cases}
v_{22}^Tb = 0\\
v_{11}b=v_{12}b
\end{cases}
$$


​		&#8195;&#8195;写成矩阵形式有：


$$
\left[
\begin{matrix}
v_{12}^T \\
v_{11}-v_{22}
\end{matrix}
\right]
b
= Vb =0
$$


​		&#8195;&#8195;这是仅仅使用一对图像计算射影变换矩阵时的方程，当采集到了多组图像时只需要将对应的$V$矩阵进行拼接即可。对于方程$Vb=0$的求解问题，最常见的方法就是最小二乘法，而在现代方法中常常使用$SVD$分解来求解这类问题，对SVD分解感兴趣的同学可以自行查找，这是一个十分常见的方法。在张正友论文的附录中给出了内参矩阵的计算方法：


$$
\begin{cases}
v_0 = (B_{12}B_{13}-B_{11}B_{23})/(B_{11}B_{22}-B_{12}^2) \\
u_0 = \gamma v_0/\beta - B_{13}\alpha^2/\lambda \\
\lambda = B_{33}-[B_{13}^2+v_0(B_{12}B_{13}-B_{11}B_{23})]/B_{11} \\
\alpha = \sqrt{\lambda / B_{11}} \\
\beta = \sqrt{\lambda B_{11} / (B_{11}B_{22}-B_{12}^2)} \\
\gamma = -B_{12}\alpha^2\beta / \lambda
\end{cases}
$$



## 消除畸变

​		&#8195;&#8195;在真实的相机中会因为光学透镜固有的问题而产生透视失真，通常可以将其分为枕形畸变、桶形畸变和线性畸变，其中枕形畸变和桶形畸变由于是径向对称的，因此也被称为径向畸变，使用下面的式子来表示径向畸变：


$$
\hat{x} = x + x[k_1(x^2+y^2)+k_2(x^2+y^2)^2] \\
\hat{y} = y + y[k_1(x^2+y^2)+k_2(x^2+y^2)^2]
$$


​		&#8195;&#8195;其中$k_1,k_2$表示径向畸变的系数，而且径向畸变的中心是相机的中心，则有：


$$
\hat{\mu} = \mu + (\mu-\mu_0)[k_1(x^2+y^2)+k_2(x^2+y^2)^2] \\
\hat{\nu} = \nu + (\nu-\nu_0)[k_1(x^2+y^2)+k_2(x^2+y^2)^2]
$$


​		&#8195;&#8195;继续将上式改写成矩阵形式，这个式子是从一幅图像上取点得到的，假设有$n$幅图像和$m$个图像点，那么便可以得到$2mn$个方程：


$$
\left[
\begin{matrix}
(\mu-\mu_0)(x^2+y^2) & (\mu-\mu_0)(x^2+y^2)^2 \\
(\nu-\nu_0)(x^2+y^2) & (\nu-\nu_0)(x^2+y^2)^2
\end{matrix}
\right]
\left[
\begin{matrix}
k_1 \\
k_2
\end{matrix}
\right]
=
\left[
\begin{matrix}
\hat{\mu}-\mu \\
\hat{\nu}-\nu
\end{matrix}
\right]
$$


​		&#8195;&#8195;之后同样可以使用SVD对矩阵进行分解进而得到畸变参数$k=[k_1,k_2]^T$的最小二乘解，在得到畸变参数后便可以先对图像进行去畸变处理，之后在使用进行过去畸变的图像来估计相机的内参：


$$
Dk=d \\
k = [k_1 \ \ k_2]^T = (D^TD)^{-1}D^Td
$$



## 总结

​		&#8195;&#8195;在本节课中详细的介绍了张正友的内参相机标定法，使用这一方法可以使用棋盘格标定板快速的获得相机的内参数。这一方法已经十分成熟，在实际使用中并不需要我们手写代码去实现这一功能，在下一节课中我们将会学习如何使用ROS中的程序快速的实现相机的内参标定。



## 参考资料

[1] https://baike.baidu.com/item/镜头畸变/5120871

[2] https://www.cnblogs.com/wangguchangqing/p/8335131.html

[3] Zhang, Z. A flexible new technique for camera calibration[J]. IEEE Transactions on Pattern Analysis and Machine Intelligence, 2000, 22(11):0-1334.